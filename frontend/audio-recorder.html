<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>MediaRecorder API - Upload Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 50px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
      cursor: pointer;
    }

    audio {
      margin-top: 20px;
      width: 300px;
    }

    #status {
      margin-top: 15px;
      color: green;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h2>üé§ Thu √Çm & G·ª≠i API</h2>
  <button id="startBtn">B·∫Øt ƒë·∫ßu ghi √¢m</button>
  <button id="stopBtn" disabled>D·ª´ng ghi √¢m</button>
  <button id="downloadBtn" disabled>T·∫£i file</button>
  <button id="uploadBtn" disabled>G·ª≠i API</button>

  <audio id="audioPlayer" controls></audio>
  <div id="status"></div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;

    // B·∫Øt ƒë·∫ßu ghi √¢m
    document.getElementById("startBtn").addEventListener("click", async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        if (event.data.size > 0) {
          audioChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const audioUrl = URL.createObjectURL(audioBlob);
        document.getElementById("audioPlayer").src = audioUrl;
        document.getElementById("downloadBtn").disabled = false;
        document.getElementById("uploadBtn").disabled = false;
      };

      mediaRecorder.start();
      document.getElementById("status").textContent = "‚è∫ ƒêang ghi √¢m...";
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
    });

    // D·ª´ng ghi √¢m
    document.getElementById("stopBtn").addEventListener("click", () => {
      mediaRecorder.stop();
      document.getElementById("status").textContent = "‚úÖ ƒê√£ ghi √¢m xong";
      document.getElementById("startBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;
    });

    // T·∫£i file √¢m thanh
    document.getElementById("downloadBtn").addEventListener("click", () => {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(audioBlob);
      a.download = "recorded-audio.webm";
      a.click();
    });

    // G·ª≠i d·ªØ li·ªáu l√™n API (demo)
    document.getElementById("uploadBtn").addEventListener("click", async () => {
      const formData = new FormData();
      formData.append("audio", audioBlob, "recorded-audio.webm");

      document.getElementById("status").textContent = "üì§ ƒêang g·ª≠i d·ªØ li·ªáu...";

      try {
        // API gi·∫£ l·∫≠p (httpbin.org s·∫Ω tr·∫£ l·∫°i th√¥ng tin nh·∫≠n ƒë∆∞·ª£c)
        const response = await fetch("http://localhost:5000/upload", {
          method: "POST",
          body: formData
        });

        const result = await response.json();
        console.log(result); // Xem d·ªØ li·ªáu tr·∫£ v·ªÅ trong console

        if (response.ok) {
          document.getElementById("status").textContent = "‚úÖ G·ª≠i d·ªØ li·ªáu th√†nh c√¥ng!";
        } else {
          document.getElementById("status").textContent = "‚ùå G·ª≠i th·∫•t b·∫°i!";
        }
      } catch (error) {
        document.getElementById("status").textContent = "‚ö† L·ªói k·∫øt n·ªëi API!";
      }
    });
  </script>
</body>

</html>